<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Schedule - Now & Next</title>
    <style>
        :root {
            --color-bg: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --color-card-bg: #ffffff;
            --color-header-bg: #fff5f7;
            --color-border: #ffd6dd;
            --color-text-primary: #1a202c;
            --color-text-secondary: #4a5568;
            --color-text-muted: #718096;
            --color-now: #ed64a6;
            --color-next: #9f7aea;
            --color-free: #48bb78;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: var(--font-main);
            background: var(--color-bg);
            color: var(--color-text-primary);
            display: flex;
            flex-direction: column;
            padding: 0.8vh 1.2vh;
        }

        /* Header */
        #header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5vh 2.5vh;
            box-shadow: var(--shadow-lg);
            flex-shrink: 0;
        }

        #logo-container {
            display: flex;
            align-items: center;
            gap: 1.5vh;
        }
        
        #logo-img {
            height: 5vh;
            width: auto;
        }

        #header-text {
            flex: 1;
            text-align: center;
        }
        
        h1 {
            color: var(--color-text-primary);
            font-size: clamp(1.2rem, 2.8vh, 2.5rem);
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #clock-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5vh;
        }

        #clock {
            font-size: clamp(0.9rem, 2vh, 1.8rem);
            color: var(--color-text-secondary);
            font-weight: 600;
        }

        #week-display {
            font-size: clamp(0.7rem, 1.5vh, 1.3rem);
            font-weight: 600;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 0.5vh 1.2vh;
            border-radius: 20px;
            color: white;
        }

        /* Controls */
        #controls {
            display: flex;
            gap: 1.5vh;
            align-items: center;
            margin-bottom: 0.8vh;
            padding: 1vh 2vh;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }

        #search-container {
            flex: 1;
            position: relative;
        }

        #teacher-search {
            width: 100%;
            padding: 1vh 1.5vh;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: clamp(0.9rem, 1.8vh, 1.5rem);
            font-family: var(--font-main);
            transition: all 0.2s ease;
        }

        #teacher-search:focus {
            outline: none;
            border-color: #f5576c;
            box-shadow: 0 0 0 3px rgba(245, 87, 108, 0.1);
        }

        .filter-btn {
            padding: 1vh 2vh;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: white;
            color: var(--color-text-primary);
            font-size: clamp(0.8rem, 1.6vh, 1.4rem);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-main);
        }

        .filter-btn:hover {
            background: #fff5f7;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-color: #f5576c;
        }

        #teacher-count {
            font-size: clamp(0.8rem, 1.6vh, 1.4rem);
            color: var(--color-text-muted);
            font-weight: 600;
            padding: 1vh 1.5vh;
            background: var(--color-header-bg);
            border-radius: 8px;
        }
        
        /* Main container */
        #nowNextView {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }
        
        #now-next-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1vh;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 0.5vh;
        }
        
        /* Scrollbar styling */
        #now-next-container::-webkit-scrollbar {
            width: 8px;
        }
        
        #now-next-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        #now-next-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        #now-next-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Teacher cards */
        .teacher-card {
            background: var(--color-card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            min-height: 250px;
        }
        
        .teacher-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
        }
        
        .teacher-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .teacher-card.free-period {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.05) 0%, rgba(72, 187, 120, 0.1) 100%);
        }
        
        .teacher-card.free-period::before {
            background: var(--color-free);
        }
        
        .teacher-header {
            padding: 1.5vh 2vh;
            background: var(--color-header-bg);
            border-bottom: 2px solid var(--color-border);
        }
        
        .teacher-header h2 {
            font-size: clamp(1rem, 2.2vh, 2rem);
            color: var(--color-text-primary);
            font-weight: 700;
            letter-spacing: -0.01em;
        }
        
        .teacher-body {
            padding: 1.5vh 2vh;
            display: flex;
            flex-direction: column;
            gap: 1.5vh;
            flex-grow: 1;
        }
        
        /* Event blocks */
        .event {
            display: flex;
            flex-direction: column;
            gap: 0.8vh;
        }
        
        .event-type {
            font-weight: 700;
            font-size: clamp(0.65rem, 1.4vh, 1.2rem);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 0.5vh 1vh;
            border-radius: 6px;
            display: inline-block;
            width: fit-content;
        }
        
        .event-type.now { 
            background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);
            color: white;
        }
        
        .event-type.next { 
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
            color: white;
        }
        
        .event-type.free { 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .event-content {
            background: var(--color-header-bg);
            padding: 1.2vh 1.5vh;
            border-radius: 8px;
            border-left: 3px solid #f5576c;
            transition: all 0.2s ease;
        }
        
        .event-content:hover {
            background: #ffebef;
            border-left-width: 4px;
            transform: translateX(2px);
        }
        
        .event-content.free-time {
            border-left-color: var(--color-free);
        }
        
        .event-subject {
            font-size: clamp(0.9rem, 1.9vh, 1.7rem);
            font-weight: 600;
            margin-bottom: 0.5vh;
            color: var(--color-text-primary);
            line-height: 1.4;
        }
        
        .event-class {
            font-size: clamp(0.8rem, 1.7vh, 1.5rem);
            color: var(--color-text-secondary);
            font-weight: 600;
            margin-bottom: 0.4vh;
        }
        
        .event-location {
            font-size: clamp(0.75rem, 1.5vh, 1.3rem);
            color: var(--color-text-muted);
            font-weight: 500;
        }
        
        .event-time {
            font-size: clamp(0.75rem, 1.5vh, 1.3rem);
            color: #f5576c;
            font-weight: 600;
            margin-top: 0.4vh;
        }
        
        .event-none {
            font-size: clamp(0.8rem, 1.7vh, 1.5rem);
            color: var(--color-text-muted);
            text-align: center;
            padding: 2vh;
            font-style: italic;
        }
        
        .free-period-msg {
            font-size: clamp(0.85rem, 1.8vh, 1.6rem);
            color: var(--color-free);
            font-weight: 600;
            text-align: center;
            padding: 1.5vh;
        }
        
        /* Loading and error states */
        .status-message {
            text-align: center;
            padding: 4vh;
            color: white;
            font-size: clamp(1rem, 2.5vh, 2rem);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin: 2vh;
            grid-column: 1 / -1;
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.9);
        }
        
        /* Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .teacher-card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            #now-next-container {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="logo-container">
            <img id="logo-img" src="ies.ico" alt="Logo" onerror="this.style.display='none'">
            <h1>Teacher Schedule - Now & Next</h1>
        </div>
        <div id="clock-container">
            <div id="clock">Loading...</div>
            <div id="week-display">Week --</div>
        </div>
    </div>

    <div id="controls">
        <div id="search-container">
            <input type="text" id="teacher-search" placeholder="Search for a teacher..." autocomplete="off">
        </div>
        <button class="filter-btn active" data-filter="all">All Teachers</button>
        <button class="filter-btn" data-filter="teaching">Teaching Now</button>
        <button class="filter-btn" data-filter="free">Free Period</button>
        <div id="teacher-count">-- teachers</div>
    </div>

    <div id="nowNextView">
        <div id="now-next-container">
            <div class="status-message">Loading schedules...</div>
        </div>
    </div>

    <script>
        let allLessons = [];
        let currentFilter = 'all';
        let searchTerm = '';

        function timeToMinutes(timeStr) {
            const h = parseInt(timeStr.substring(0, 2), 10);
            const m = parseInt(timeStr.substring(2, 4), 10);
            return h * 60 + m;
        }

        function minutesToTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function parseWeekRanges(weekStr) {
            if (!weekStr || weekStr.trim() === '') return [];
            const weeks = [];
            const parts = weekStr.split(',').map(s => s.trim()).filter(s => s);
            for (const part of parts) {
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(Number);
                    for (let i = start; i <= end; i++) {
                        weeks.push(i);
                    }
                } else {
                    weeks.push(Number(part));
                }
            }
            return weeks;
        }

        function parseLessons(tsv) {
            const lessons = [];
            const lines = tsv.trim().split(/[\r\n]+/);
            
            if (lines.length < 2) {
                console.error("No data found");
                return [];
            }
            
            const headers = lines[0].split('\t').map(h => h.trim());
            const colIdx = {
                group: headers.indexOf('group'),
                subject: headers.indexOf('subject'),
                day: headers.indexOf('day'),
                starttime: headers.indexOf('starttime'),
                length: headers.indexOf('length'),
                room: headers.indexOf('room'),
                realweeks: headers.indexOf('realweeks'),
                teacher: headers.indexOf('teacher')
            };

            for (const key in colIdx) {
                if (colIdx[key] === -1) {
                    console.error(`Missing column: ${key}`);
                    return [];
                }
            }
            
            const validDays = ["Mon", "Tue", "Wed", "Thur", "Fri"];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('\t');
                if (values.length < headers.length) continue;

                const teacherStr = values[colIdx.teacher].trim();
                if (!teacherStr) continue; // Skip lessons without teachers

                const day = values[colIdx.day].trim();
                const startTimeStr = values[colIdx.starttime].trim().padStart(4, '0');
                const length = parseInt(values[colIdx.length], 10);
                const subject = values[colIdx.subject].trim();
                const room = values[colIdx.room].trim();
                const group = values[colIdx.group].trim();
                
                if (subject.includes('D46') || room.includes('D46')) continue;
                if (!validDays.includes(day) || !startTimeStr || length <= 0) continue;

                const startTime = timeToMinutes(startTimeStr);
                const lessonData = {
                    group: group,
                    subject: subject,
                    day: day,
                    room: room,
                    teacher: teacherStr,
                    startTime: startTime,
                    endTime: startTime + length,
                    startTimeStr: minutesToTime(startTime),
                    endTimeStr: minutesToTime(startTime + length),
                    validWeeks: parseWeekRanges(values[colIdx.realweeks])
                };

                // Split by comma if multiple teachers
                const teachers = teacherStr.split(',').map(t => t.trim());
                for (const teacher of teachers) {
                    if (teacher) {
                        lessons.push({ ...lessonData, teacher: teacher });
                    }
                }
            }
            return lessons;
        }

        function getLessonsForTeacher(teacherName, nowDay, currentWeek) {
            const dayMap = ["", "Mon", "Tue", "Wed", "Thur", "Fri"];
            const currentDayStr = dayMap[nowDay];
            if (!currentDayStr) return [];

            const lessons = allLessons.filter(l => {
                if (l.day !== currentDayStr || !l.validWeeks.includes(currentWeek)) {
                    return false;
                }
                return l.teacher === teacherName;
            });
            
            return lessons.sort((a, b) => a.startTime - b.startTime);
        }

        function getNowAndNext(todayLessons, nowMinutes) {
            const nowLesson = todayLessons.find(l => 
                nowMinutes >= l.startTime && nowMinutes < l.endTime
            );

            let nextLesson = null;
            let nextStartTime = Infinity;
            let referenceTime = nowMinutes;

            if (nowLesson) {
                referenceTime = nowLesson.endTime - 1;
            }

            for (const lesson of todayLessons) {
                if (lesson.startTime > referenceTime && lesson.startTime < nextStartTime) {
                    nextStartTime = lesson.startTime;
                    nextLesson = lesson;
                }
            }

            return { nowLesson, nextLesson };
        }

        function createEventHTML(lesson, type) {
            if (!lesson) {
                if (type === 'Now') {
                    return `
                        <div class="event">
                            <div class="event-type free">Free Period</div>
                            <div class="free-period-msg">No class scheduled</div>
                        </div>`;
                } else {
                    return `
                        <div class="event">
                            <div class="event-type next">Next</div>
                            <div class="event-none">End of day</div>
                        </div>`;
                }
            }

            const typeClass = type.toLowerCase();
            const timeDisplay = type === 'Now' 
                ? `Until ${lesson.endTimeStr}` 
                : `At ${lesson.startTimeStr}`;
            const location = lesson.room ? `üìç ${lesson.room}` : '';

            return `
                <div class="event">
                    <div class="event-type ${typeClass}">${type}</div>
                    <div class="event-content">
                        <div class="event-subject">${lesson.subject}</div>
                        <div class="event-class">Class: ${lesson.group}</div>
                        ${location ? `<div class="event-location">${location}</div>` : ''}
                        <div class="event-time">${timeDisplay}</div>
                    </div>
                </div>
            `;
        }

        function getAllTeachers() {
            const teachers = new Set();
            allLessons.forEach(lesson => {
                if (lesson.teacher) {
                    teachers.add(lesson.teacher);
                }
            });
            return Array.from(teachers).sort();
        }

        function updateDashboard() {
            const allTeachers = getAllTeachers();
            const nowNextContainer = document.getElementById('now-next-container');
            nowNextContainer.innerHTML = '';
            
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Stockholm"}));
            const nowDay = now.getDay();
            const nowMinutes = (now.getHours() * 60) + now.getMinutes();
            const currentWeek = getWeekNumber(now);

            const clockEl = document.getElementById('clock');
            const weekEl = document.getElementById('week-display');
            const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            
            clockEl.textContent = `${dayNames[nowDay]}, ${minutesToTime(nowMinutes)}`;
            weekEl.textContent = `Week ${currentWeek}`;

            if (nowDay === 0 || nowDay === 6) {
                nowNextContainer.innerHTML = '<div class="status-message">It\'s the weekend! All teachers are off duty.</div>';
                document.getElementById('teacher-count').textContent = '0 teachers';
                return;
            }

            if (allTeachers.length === 0) {
                nowNextContainer.innerHTML = '<div class="status-message">No teachers found in schedule.</div>';
                document.getElementById('teacher-count').textContent = '0 teachers';
                return;
            }

            let displayedCount = 0;

            for (const teacher of allTeachers) {
                // Apply search filter
                if (searchTerm && !teacher.toLowerCase().includes(searchTerm.toLowerCase())) {
                    continue;
                }

                const todayLessons = getLessonsForTeacher(teacher, nowDay, currentWeek);
                const { nowLesson, nextLesson } = getNowAndNext(todayLessons, nowMinutes);
                
                // Apply status filter
                const isTeaching = !!nowLesson;
                const isFree = !nowLesson;
                
                if (currentFilter === 'teaching' && !isTeaching) continue;
                if (currentFilter === 'free' && !isFree) continue;

                const card = document.createElement('div');
                card.className = 'teacher-card';
                if (isFree) {
                    card.classList.add('free-period');
                }
                
                card.innerHTML = `
                    <div class="teacher-header"><h2>${teacher}</h2></div>
                    <div class="teacher-body">
                        ${createEventHTML(nowLesson, 'Now')}
                        ${createEventHTML(nextLesson, 'Next')}
                    </div>
                `;
                nowNextContainer.appendChild(card);
                displayedCount++;
            }

            document.getElementById('teacher-count').textContent = `${displayedCount} teacher${displayedCount !== 1 ? 's' : ''}`;

            if (displayedCount === 0) {
                nowNextContainer.innerHTML = '<div class="status-message">No teachers match your search criteria.</div>';
            }
        }

        // Event listeners for filters
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                updateDashboard();
            });
        });

        // Event listener for search
        document.getElementById('teacher-search').addEventListener('input', function(e) {
            searchTerm = e.target.value;
            updateDashboard();
        });

        async function loadDataAndRun() {
            try {
                const response = await fetch('Lessons.tsv?cachebust=' + new Date().getTime(), {
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to load Lessons.tsv (Status: ${response.status})`);
                }

                const buffer = await response.arrayBuffer();
                const tsvData = new TextDecoder('utf-8').decode(buffer);
                allLessons = parseLessons(tsvData);
                
                if (allLessons.length === 0) {
                    throw new Error("No lessons found in data file");
                }
                
                updateDashboard();
                setInterval(updateDashboard, 30000);

            } catch (error) {
                console.error(error);
                const container = document.getElementById('now-next-container');
                container.innerHTML = `
                    <div class="status-message error-message">
                        <strong>Error: Could not load schedule</strong><br>
                        ${error.message}<br>
                        <small>Make sure Lessons.tsv is in the same directory</small>
                    </div>`;
            }
        }

        window.addEventListener('resize', updateDashboard);
        loadDataAndRun();
    </script>
</body>
</html>
